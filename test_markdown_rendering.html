<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Rendering Test - Synapse</title>
    <link rel="stylesheet" href="static/css/style.css">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
    <div class="hud-container">
        <div class="chat-pane">
            <header class="hud-header">
                <h1 class="hud-title">MARKDOWN RENDERING TEST</h1>
                <p class="hud-subtitle">Testing Synapse Markdown Implementation</p>
            </header>
            
            <main class="chat-main">
                <div id="chat-log" class="chat-log">
                    <!-- Test messages will be displayed here -->
                </div>
                
                <div class="input-section glass-panel">
                    <div class="input-container">
                        <button id="test-plain-text" class="hud-button secondary">Test Plain Text</button>
                        <button id="test-markdown" class="hud-button primary">Test Markdown</button>
                        <button id="clear-chat" class="hud-button">Clear</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Markdown rendering utilities
        const MarkdownRenderer = {
            configure() {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false
                    });
                }
            },

            render(markdownText) {
                if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                    console.warn('Markdown libraries not loaded, falling back to plain text');
                    return this.escapeHtml(markdownText);
                }

                try {
                    const rawHtml = marked.parse(markdownText);
                    const cleanHtml = DOMPurify.sanitize(rawHtml, {
                        ALLOWED_TAGS: [
                            'p', 'br', 'strong', 'em', 'u', 'strike', 'del',
                            'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                            'ul', 'ol', 'li',
                            'blockquote', 'pre', 'code',
                            'a', 'span', 'div'
                        ],
                        ALLOWED_ATTR: ['href', 'target', 'class'],
                        ALLOW_DATA_ATTR: false
                    });
                    return cleanHtml;
                } catch (error) {
                    console.error('Markdown rendering error:', error);
                    return this.escapeHtml(markdownText);
                }
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            setContent(element, content) {
                const renderedHtml = this.render(content);
                element.innerHTML = renderedHtml;
            }
        };

        // Initialize
        MarkdownRenderer.configure();

        // Test data
        const plainTextMessage = "This is a plain text message without any formatting. It should appear as a single paragraph with no special styling.";
        
        const markdownMessage = `# This is a Heading

This is a **bold statement** and this is an *italic phrase*.

Here are some key points:

- First important point
- Second critical insight
- Third valuable observation

## Subheading for More Details

Here's a numbered list:

1. First step in the process
2. Second step to consider
3. Final step to complete

> This is a blockquote that represents a thought-provoking insight or reflection.

Here's some \`inline code\` and a code block:

\`\`\`
function example() {
    return "This is a code block";
}
\`\`\`

**What patterns do you notice in your own thinking about this?**`;

        function addMessage(content, isMarkdown = false) {
            const chatLog = document.getElementById('chat-log');
            
            // Create message container
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'ai-message');
            
            // Create message content
            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            
            const textElement = document.createElement('div');
            textElement.classList.add('message-text-content');
            
            if (isMarkdown) {
                MarkdownRenderer.setContent(textElement, content);
            } else {
                textElement.textContent = content;
            }
            
            contentElement.appendChild(textElement);
            messageElement.appendChild(contentElement);
            chatLog.appendChild(messageElement);
            
            // Scroll to bottom
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Event listeners
        document.getElementById('test-plain-text').addEventListener('click', () => {
            addMessage(plainTextMessage, false);
        });

        document.getElementById('test-markdown').addEventListener('click', () => {
            addMessage(markdownMessage, true);
        });

        document.getElementById('clear-chat').addEventListener('click', () => {
            document.getElementById('chat-log').innerHTML = '';
        });

        // Add initial message
        setTimeout(() => {
            addMessage("Welcome to the Markdown rendering test! Click the buttons below to see the difference between plain text and Markdown formatting.", false);
        }, 500);
    </script>
</body>
</html>
