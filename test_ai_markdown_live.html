<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Test - Live AI Response</title>
    <link rel="stylesheet" href="static/css/style.css">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
    <div class="hud-container">
        <div class="chat-pane">
            <header class="hud-header">
                <h1 class="hud-title">MARKDOWN RENDERING - LIVE TEST</h1>
                <p class="hud-subtitle">Testing AI-Generated Markdown Responses</p>
                <div class="status-indicators">
                    <div class="connection-status connected" id="connection-status">
                        <span id="status-text">TESTING</span>
                    </div>
                </div>
            </header>
            
            <main class="chat-main">
                <div id="test-results" class="chat-log">
                    <div class="message user-message">
                        <div class="message-content">
                            <div class="message-text-content">
                                <strong>Test Query:</strong> Can you provide a structured response with headings, lists, and formatting to demonstrate the Markdown rendering?
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-section glass-panel">
                    <div class="input-container">
                        <button id="test-ai-response" class="hud-button primary">
                            <span class="button-icon">ü§ñ</span>
                            Test AI Markdown Response
                        </button>
                        <button id="clear-results" class="hud-button secondary">
                            <span class="button-icon">üóëÔ∏è</span>
                            Clear
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Markdown rendering utilities
        const MarkdownRenderer = {
            configure() {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false
                    });
                }
            },

            render(markdownText) {
                if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                    console.warn('Markdown libraries not loaded, falling back to plain text');
                    return this.escapeHtml(markdownText);
                }

                try {
                    const rawHtml = marked.parse(markdownText);
                    const cleanHtml = DOMPurify.sanitize(rawHtml, {
                        ALLOWED_TAGS: [
                            'p', 'br', 'strong', 'em', 'u', 'strike', 'del',
                            'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                            'ul', 'ol', 'li',
                            'blockquote', 'pre', 'code',
                            'a', 'span', 'div'
                        ],
                        ALLOWED_ATTR: ['href', 'target', 'class'],
                        ALLOW_DATA_ATTR: false
                    });
                    return cleanHtml;
                } catch (error) {
                    console.error('Markdown rendering error:', error);
                    return this.escapeHtml(markdownText);
                }
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            setContent(element, content) {
                const renderedHtml = this.render(content);
                element.innerHTML = renderedHtml;
            }
        };

        // Initialize
        MarkdownRenderer.configure();

        function addAIResponse(content) {
            const resultsContainer = document.getElementById('test-results');
            
            // Create AI message container
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'ai-message');
            
            // Create message content
            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            
            const textElement = document.createElement('div');
            textElement.classList.add('message-text-content');
            
            // Use Markdown renderer
            MarkdownRenderer.setContent(textElement, content);
            
            contentElement.appendChild(textElement);
            messageElement.appendChild(contentElement);
            resultsContainer.appendChild(messageElement);
            
            // Scroll to bottom
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const resultsContainer = document.getElementById('test-results');
            
            const loadingElement = document.createElement('div');
            loadingElement.classList.add('message', 'ai-message', 'loading');
            loadingElement.id = 'loading-message';
            loadingElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text-content">
                        <em>ü§ñ Generating AI response with Markdown formatting...</em>
                    </div>
                </div>
            `;
            
            resultsContainer.appendChild(loadingElement);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingElement = document.getElementById('loading-message');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        async function testAIResponse() {
            const statusText = document.getElementById('status-text');
            statusText.textContent = 'TESTING AI...';
            
            addLoadingMessage();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Please provide a structured response demonstrating Markdown formatting. Include: a heading, some bold and italic text, a bulleted list of 3 items, a numbered list, and a blockquote with a thought-provoking question. Make it about the benefits of structured thinking.'
                    })
                });

                const data = await response.json();
                
                removeLoadingMessage();
                
                if (data.error) {
                    addAIResponse(`**Error**: ${data.message || 'Unknown error occurred'}`);
                    statusText.textContent = 'ERROR';
                } else {
                    addAIResponse(data.response);
                    statusText.textContent = 'SUCCESS ‚úì';
                }
                
            } catch (error) {
                removeLoadingMessage();
                addAIResponse(`**Connection Error**: ${error.message}`);
                statusText.textContent = 'FAILED';
                console.error('Test failed:', error);
            }
        }

        // Event listeners
        document.getElementById('test-ai-response').addEventListener('click', testAIResponse);
        
        document.getElementById('clear-results').addEventListener('click', () => {
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = `
                <div class="message user-message">
                    <div class="message-content">
                        <div class="message-text-content">
                            <strong>Test Query:</strong> Can you provide a structured response with headings, lists, and formatting to demonstrate the Markdown rendering?
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('status-text').textContent = 'READY';
        });

        // Initial status
        setTimeout(() => {
            document.getElementById('status-text').textContent = 'READY';
        }, 1000);
    </script>
</body>
</html>
