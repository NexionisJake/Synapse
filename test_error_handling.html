<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling System Test - Synapse</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <div class="hud-container">
        <div class="chat-pane">
            <header class="hud-header">
                <h1 class="hud-title">ERROR HANDLING TEST</h1>
                <p class="hud-subtitle">Testing Comprehensive Error Handling System</p>
            </header>
            
            <main class="chat-main">
                <div id="chat-log" class="chat-log">
                    <!-- Test messages will appear here -->
                </div>
                
                <div class="test-controls glass-panel">
                    <h3>Streaming Error Tests</h3>
                    <div class="test-buttons">
                        <button onclick="testTimeoutError()" class="hud-button primary">
                            Test Timeout Error
                        </button>
                        <button onclick="testNetworkError()" class="hud-button primary">
                            Test Network Error
                        </button>
                        <button onclick="testAIServiceError()" class="hud-button primary">
                            Test AI Service Error
                        </button>
                        <button onclick="testValidationError()" class="hud-button primary">
                            Test Validation Error
                        </button>
                        <button onclick="testUnknownError()" class="hud-button primary">
                            Test Unknown Error
                        </button>
                    </div>
                    
                    <h3>Chart Error Tests</h3>
                    <div class="test-buttons">
                        <button onclick="testChartCanvasError()" class="hud-button secondary">
                            Test Canvas Error
                        </button>
                        <button onclick="testChartDataError()" class="hud-button secondary">
                            Test Data Error
                        </button>
                        <button onclick="testChartNetworkError()" class="hud-button secondary">
                            Test Chart Network Error
                        </button>
                        <button onclick="testChartLibraryError()" class="hud-button secondary">
                            Test Chart Library Error
                        </button>
                    </div>
                    
                    <h3>Error Statistics</h3>
                    <div class="error-stats">
                        <button onclick="showStreamingStats()" class="hud-button">
                            Show Streaming Error Stats
                        </button>
                        <button onclick="showChartStats()" class="hud-button">
                            Show Chart Error Stats
                        </button>
                        <button onclick="clearErrorLogs()" class="hud-button">
                            Clear Error Logs
                        </button>
                    </div>
                </div>
            </main>
        </div>
        
        <div class="cognitive-dashboard">
            <header class="dashboard-header">
                <h2 class="dashboard-title">CHART ERROR TESTING</h2>
            </header>
            
            <div class="dashboard-content">
                <section class="charts-section">
                    <div class="charts-grid">
                        <!-- Test Chart Containers -->
                        <div class="chart-container glass-panel" id="test-chart-1-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Test Chart 1</h4>
                                <div class="chart-status" id="test-chart-1-status">Ready</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="test-chart-1" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container glass-panel" id="test-chart-2-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Test Chart 2</h4>
                                <div class="chart-status" id="test-chart-2-status">Ready</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="test-chart-2" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container glass-panel" id="test-chart-3-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Test Chart 3</h4>
                                <div class="chart-status" id="test-chart-3-status">Ready</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="test-chart-3" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- Include error handling system -->
    <script src="static/js/error-handlers.js"></script>
    
    <script>
        // Test functions for streaming errors
        function testTimeoutError() {
            const responseElement = createTestResponseElement();
            const error = new Error('Request timeout');
            error.name = 'AbortError';
            
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.handleStreamingError(
                    error, 
                    responseElement, 
                    Date.now() - 30000, 
                    'test_timeout'
                );
            }
        }
        
        function testNetworkError() {
            const responseElement = createTestResponseElement();
            const error = new Error('Failed to fetch');
            error.name = 'TypeError';
            
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.handleStreamingError(
                    error, 
                    responseElement, 
                    Date.now() - 5000, 
                    'test_network'
                );
            }
        }
        
        function testAIServiceError() {
            const responseElement = createTestResponseElement();
            const error = new Error('AI service is not available. Please ensure Ollama is running.');
            
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.handleStreamingError(
                    error, 
                    responseElement, 
                    Date.now() - 3000, 
                    'test_ai_service'
                );
            }
        }
        
        function testValidationError() {
            const responseElement = createTestResponseElement();
            const error = new Error('Invalid message format detected');
            
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.handleStreamingError(
                    error, 
                    responseElement, 
                    Date.now() - 1000, 
                    'test_validation'
                );
            }
        }
        
        function testUnknownError() {
            const responseElement = createTestResponseElement();
            const error = new Error('Something unexpected happened');
            
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.handleStreamingError(
                    error, 
                    responseElement, 
                    Date.now() - 2000, 
                    'test_unknown'
                );
            }
        }
        
        // Test functions for chart errors
        function testChartCanvasError() {
            const error = new Error('Canvas is already in use by another chart');
            
            if (window.chartErrorHandler) {
                window.chartErrorHandler.handleChartError(
                    'test-chart-1', 
                    'bar', 
                    error, 
                    { source: 'canvas_test' }
                );
            }
        }
        
        function testChartDataError() {
            const error = new Error('Invalid data format for chart rendering');
            
            if (window.chartErrorHandler) {
                window.chartErrorHandler.handleChartError(
                    'test-chart-2', 
                    'line', 
                    error, 
                    { source: 'data_test' }
                );
            }
        }
        
        function testChartNetworkError() {
            const error = new Error('Failed to fetch chart data from server');
            error.name = 'TypeError';
            
            if (window.chartErrorHandler) {
                window.chartErrorHandler.handleChartError(
                    'test-chart-3', 
                    'doughnut', 
                    error, 
                    { source: 'network_test' }
                );
            }
        }
        
        function testChartLibraryError() {
            const error = new Error('Chart.js library error: Invalid configuration');
            
            if (window.chartErrorHandler) {
                window.chartErrorHandler.handleChartError(
                    'test-chart-1', 
                    'radar', 
                    error, 
                    { source: 'library_test' }
                );
            }
        }
        
        // Utility functions
        function createTestResponseElement() {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'ai-message', 'streaming');
            messageElement.id = 'test_response_' + Date.now();
            
            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            messageElement.appendChild(contentElement);
            
            document.getElementById('chat-log').appendChild(messageElement);
            
            return messageElement;
        }
        
        function showStreamingStats() {
            if (window.streamingErrorHandler) {
                const stats = window.streamingErrorHandler.getErrorStats();
                alert('Streaming Error Stats:\n' + JSON.stringify(stats, null, 2));
            } else {
                alert('Streaming error handler not available');
            }
        }
        
        function showChartStats() {
            if (window.chartErrorHandler) {
                const stats = window.chartErrorHandler.getErrorStats();
                alert('Chart Error Stats:\n' + JSON.stringify(stats, null, 2));
            } else {
                alert('Chart error handler not available');
            }
        }
        
        function clearErrorLogs() {
            if (window.streamingErrorHandler) {
                window.streamingErrorHandler.reset();
            }
            if (window.chartErrorHandler) {
                window.chartErrorHandler.reset();
            }
            alert('Error logs cleared');
        }
        
        // Initialize test environment
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Error handling test page loaded');
            
            // Check if error handlers are available
            setTimeout(() => {
                if (window.streamingErrorHandler && window.chartErrorHandler) {
                    console.log('✅ Error handling system initialized successfully');
                    
                    // Add test message
                    const testMessage = document.createElement('div');
                    testMessage.classList.add('message', 'system-message');
                    testMessage.innerHTML = `
                        <div class="system-notification">
                            <strong>Error Handling System Test Ready</strong><br>
                            Use the buttons above to test different error scenarios.
                        </div>
                    `;
                    document.getElementById('chat-log').appendChild(testMessage);
                } else {
                    console.error('❌ Error handling system not initialized');
                }
            }, 1000);
        });
    </script>
    
    <style>
        .test-controls {
            margin: 1rem;
            padding: 1rem;
        }
        
        .test-controls h3 {
            color: var(--hud-accent-cyan);
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .test-buttons button {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .error-stats {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .error-stats button {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .system-notification {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--hud-text-primary);
        }
    </style>
</body>
</html>