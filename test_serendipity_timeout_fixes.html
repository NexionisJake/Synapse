<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serendipity Timeout Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #ffffff; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #2d5a27; border: 1px solid #4a9a47; }
        .error { background: #5a2727; border: 1px solid #9a4747; }
        .warning { background: #5a5027; border: 1px solid #9a8c47; }
        .loading { background: #274a5a; border: 1px solid #477a9a; }
        button { 
            background: #0066cc; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #666; cursor: not-allowed; }
        pre { background: #1a1a1a; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: #333; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(45deg, #0066cc, #0099ff); 
            width: 0%; 
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .timeline { margin: 20px 0; }
        .timeline-item { 
            border-left: 3px solid #0066cc; 
            padding-left: 15px; 
            margin: 10px 0; 
            padding: 10px 0 10px 15px;
        }
        .timeout-info {
            background: #2a2a40;
            border: 1px solid #4040ff;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Serendipity Timeout Fix Test</h1>
        <p>This page tests the timeout fixes for serendipity analysis to ensure they work correctly.</p>
        
        <div class="test-section">
            <h2>üì° Timeout Configuration Test</h2>
            <button onclick="testTimeoutConfig()">Check Timeout Configuration</button>
            <div id="timeout-config-result"></div>
        </div>
        
        <div class="test-section">
            <h2>üî¨ Serendipity Analysis Test</h2>
            <p>This will test the actual serendipity analysis with the new timeout settings.</p>
            <div class="timeout-info">
                <h4>Expected Behavior:</h4>
                <ul>
                    <li>Frontend timeout: 3+ minutes (dynamic based on server config)</li>
                    <li>Backend timeout: 120 seconds (2 minutes)</li>
                    <li>AI service timeout: 180 seconds (3 minutes)</li>
                    <li>Better progress indicators and error messages</li>
                </ul>
            </div>
            <button onclick="testSerendipityAnalysis()" id="analysis-btn">Run Serendipity Analysis</button>
            <div id="analysis-result"></div>
            <div class="timeline" id="analysis-timeline"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Test Results Summary</h2>
            <div id="test-summary"></div>
        </div>
    </div>

    <script>
        const results = {
            timeoutConfig: null,
            serendipityAnalysis: null
        };

        function addStatus(containerId, message, type = 'loading') {
            const container = document.getElementById(containerId);
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.innerHTML = message;
            container.appendChild(status);
            return status;
        }

        function addTimelineItem(message) {
            const timeline = document.getElementById('analysis-timeline');
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
        }

        async function testTimeoutConfig() {
            const container = document.getElementById('timeout-config-result');
            container.innerHTML = '';
            
            const status = addStatus('timeout-config-result', 'üîç Checking timeout configuration...', 'loading');
            
            try {
                const response = await fetch('/api/serendipity', { method: 'GET' });
                const data = await response.json();
                
                status.className = 'status success';
                status.innerHTML = `
                    ‚úÖ <strong>Timeout Configuration Retrieved</strong><br>
                    ‚Ä¢ API Timeout: ${data.timeout}s<br>
                    ‚Ä¢ Streaming Timeout: ${data.streaming_timeout}s<br>
                    ‚Ä¢ Frontend will use: ${data.timeout + 60}s (API timeout + 60s buffer)
                `;
                
                // Show detailed configuration
                const details = document.createElement('pre');
                details.textContent = JSON.stringify(data, null, 2);
                container.appendChild(details);
                
                results.timeoutConfig = true;
                updateTestSummary();
                
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `‚ùå <strong>Failed to check timeout configuration:</strong> ${error.message}`;
                results.timeoutConfig = false;
                updateTestSummary();
            }
        }

        async function testSerendipityAnalysis() {
            const container = document.getElementById('analysis-result');
            const timeline = document.getElementById('analysis-timeline');
            const button = document.getElementById('analysis-btn');
            
            container.innerHTML = '';
            timeline.innerHTML = '';
            button.disabled = true;
            button.textContent = 'Running Analysis...';
            
            const startTime = Date.now();
            let progressInterval;
            
            try {
                addTimelineItem('Starting serendipity analysis test...');
                
                // Get dynamic timeout
                addTimelineItem('Fetching server timeout configuration...');
                const configResponse = await fetch('/api/serendipity', { method: 'GET' });
                const config = await configResponse.json();
                const dynamicTimeout = (config.timeout + 60) * 1000; // API timeout + 60s buffer
                
                addTimelineItem(`Using dynamic timeout: ${dynamicTimeout / 1000}s`);
                
                // Show progress bar
                const progressContainer = document.createElement('div');
                progressContainer.innerHTML = `
                    <div class="progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <p id="progress-text">Initializing analysis...</p>
                `;
                container.appendChild(progressContainer);
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                // Simulate progress (since we can't track real progress)
                let progress = 0;
                progressInterval = setInterval(() => {
                    progress += Math.random() * 2;
                    if (progress > 90) progress = 90; // Don't complete until we get response
                    progressBar.style.width = progress + '%';
                    
                    const messages = [
                        'Analyzing conversation patterns...',
                        'Finding hidden connections...',
                        'Processing semantic relationships...',
                        'Generating insights...',
                        'Finalizing analysis...'
                    ];
                    const messageIndex = Math.floor(progress / 20);
                    if (messages[messageIndex]) {
                        progressText.textContent = messages[messageIndex];
                    }
                }, 1000);
                
                addTimelineItem('Making API request to /api/serendipity...');
                
                // Make the actual API request with dynamic timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    addTimelineItem(`‚ö†Ô∏è Request aborted due to timeout (${dynamicTimeout / 1000}s)`);
                }, dynamicTimeout);
                
                const response = await fetch('/api/serendipity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                const duration = (Date.now() - startTime) / 1000;
                addTimelineItem(`‚úÖ Request completed in ${duration.toFixed(2)}s`);
                
                // Complete progress
                progressBar.style.width = '100%';
                progressText.textContent = 'Analysis complete!';
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const successStatus = addStatus('analysis-result', 
                        `‚úÖ <strong>Analysis Successful!</strong><br>
                        ‚Ä¢ Duration: ${duration.toFixed(2)}s<br>
                        ‚Ä¢ Connections found: ${data.connections?.length || 0}<br>
                        ‚Ä¢ Meta patterns: ${data.meta_patterns?.length || 0}<br>
                        ‚Ä¢ Status: No timeout issues detected`, 'success');
                    
                    // Show partial results
                    if (data.connections && data.connections.length > 0) {
                        const preview = document.createElement('div');
                        preview.innerHTML = `
                            <h4>Sample Connections:</h4>
                            <ul>
                                ${data.connections.slice(0, 3).map(conn => 
                                    `<li><strong>${conn.title || 'Untitled'}</strong> (Surprise: ${conn.surprise_factor || 'N/A'})</li>`
                                ).join('')}
                            </ul>
                        `;
                        container.appendChild(preview);
                    }
                    
                    results.serendipityAnalysis = true;
                    addTimelineItem('‚úÖ Test completed successfully');
                    
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || 'Unknown error'}`);
                }
                
            } catch (error) {
                clearInterval(progressInterval);
                const duration = (Date.now() - startTime) / 1000;
                
                let errorMessage = error.message;
                let errorType = 'error';
                
                if (error.name === 'AbortError') {
                    errorMessage = `Request was aborted due to timeout (${dynamicTimeout / 1000}s). This suggests the backend is taking longer than expected.`;
                    errorType = 'warning';
                    addTimelineItem('‚ö†Ô∏è Request timed out - backend may need more time');
                } else {
                    addTimelineItem(`‚ùå Error occurred: ${errorMessage}`);
                }
                
                addStatus('analysis-result', 
                    `${errorType === 'warning' ? '‚ö†Ô∏è' : '‚ùå'} <strong>Analysis ${errorType === 'warning' ? 'Timed Out' : 'Failed'}:</strong><br>
                    ‚Ä¢ Duration: ${duration.toFixed(2)}s<br>
                    ‚Ä¢ Error: ${errorMessage}`, errorType);
                
                results.serendipityAnalysis = errorType === 'warning' ? 'timeout' : false;
            } finally {
                button.disabled = false;
                button.textContent = 'Run Serendipity Analysis';
                updateTestSummary();
            }
        }

        function updateTestSummary() {
            const container = document.getElementById('test-summary');
            container.innerHTML = `
                <h3>Test Results:</h3>
                <ul>
                    <li>Timeout Configuration: ${getResultIcon(results.timeoutConfig)}</li>
                    <li>Serendipity Analysis: ${getResultIcon(results.serendipityAnalysis)}</li>
                </ul>
                ${getOverallStatus()}
            `;
        }

        function getResultIcon(result) {
            if (result === true) return '‚úÖ PASSED';
            if (result === 'timeout') return '‚ö†Ô∏è TIMEOUT (Expected for large datasets)';
            if (result === false) return '‚ùå FAILED';
            return '‚è≥ NOT RUN';
        }

        function getOverallStatus() {
            const allTests = Object.values(results);
            const passed = allTests.filter(r => r === true).length;
            const total = allTests.filter(r => r !== null).length;
            
            if (total === 0) return '<p>No tests completed yet.</p>';
            if (passed === total) return '<p class="status success">üéâ All tests passed! Timeout fixes are working correctly.</p>';
            if (allTests.some(r => r === 'timeout')) return '<p class="status warning">‚ö†Ô∏è Some timeouts occurred, but this may be expected for large datasets.</p>';
            return '<p class="status error">‚ùå Some tests failed. Please review the results above.</p>';
        }

        // Auto-run timeout config test on page load
        window.addEventListener('load', () => {
            setTimeout(testTimeoutConfig, 1000);
        });
    </script>
</body>
</html>
