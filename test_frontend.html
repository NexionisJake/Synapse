<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend JavaScript Tests - Synapse AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-summary {
            font-weight: bold;
            font-size: 18px;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        .summary-pass {
            background-color: #d4edda;
            color: #155724;
        }
        .summary-fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        #test-output {
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .mock-elements {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Synapse AI - Frontend JavaScript Tests</h1>
    
    <div class="test-container">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="runChatTests()">Run Chat Tests</button>
        <button onclick="runDashboardTests()">Run Dashboard Tests</button>
        <button onclick="runPromptTests()">Run Prompt Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-output"></div>
        <div id="test-summary"></div>
    </div>
    
    <!-- Mock DOM elements for testing -->
    <div class="mock-elements">
        <!-- Chat interface mock elements -->
        <div id="chat-log"></div>
        <input type="text" id="message-input" />
        <button id="send-button">Send</button>
        
        <!-- Dashboard mock elements -->
        <div id="loading-state"></div>
        <div id="error-state"></div>
        <div id="empty-state"></div>
        <div id="dashboard-content"></div>
        <div id="insights-container"></div>
        <div id="categories-container"></div>
        <div id="summaries-container"></div>
        <select id="category-filter"></select>
        <select id="confidence-filter"></select>
        <button id="prev-page">Previous</button>
        <button id="next-page">Next</button>
        <div id="page-info"></div>
        <div id="insights-pagination"></div>
        <button id="discover-connections">Discover</button>
        <div id="serendipity-status"></div>
        <div id="serendipity-results"></div>
        <div id="serendipity-summary-text"></div>
        <div id="connections-list"></div>
        <div id="meta-patterns-list"></div>
        <div id="recommendations-list"></div>
        
        <!-- Prompt management mock elements -->
        <div id="current-prompt-display"></div>
        <div id="prompt-stats"></div>
        <textarea id="prompt-editor"></textarea>
        <input type="text" id="prompt-name" />
        <div id="validation-result"></div>
        <div id="test-result"></div>
        <div id="prompt-history-list"></div>
    </div>

    <script>
        // Test framework
        class TestFramework {
            constructor() {
                this.tests = [];
                this.results = [];
                this.output = document.getElementById('test-output');
                this.summary = document.getElementById('test-summary');
            }
            
            addTest(name, testFunction) {
                this.tests.push({ name, testFunction });
            }
            
            async runTests(filter = null) {
                this.results = [];
                this.output.innerHTML = '';
                this.summary.innerHTML = '';
                
                const testsToRun = filter ? this.tests.filter(t => t.name.includes(filter)) : this.tests;
                
                for (const test of testsToRun) {
                    try {
                        await test.testFunction();
                        this.addResult(test.name, true, null);
                    } catch (error) {
                        this.addResult(test.name, false, error.message);
                    }
                }
                
                this.showSummary();
            }
            
            addResult(testName, passed, error) {
                this.results.push({ testName, passed, error });
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                resultDiv.innerHTML = `
                    <strong>${passed ? '✓' : '✗'} ${testName}</strong>
                    ${error ? `<br><small>Error: ${error}</small>` : ''}
                `;
                this.output.appendChild(resultDiv);
            }
            
            showSummary() {
                const total = this.results.length;
                const passed = this.results.filter(r => r.passed).length;
                const failed = total - passed;
                
                this.summary.className = `test-summary ${failed === 0 ? 'summary-pass' : 'summary-fail'}`;
                this.summary.innerHTML = `
                    Test Summary: ${passed}/${total} passed (${failed} failed)
                    ${failed === 0 ? '🎉 All tests passed!' : '❌ Some tests failed'}
                `;
            }
            
            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }
            
            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            }
            
            assertNotNull(value, message) {
                if (value === null || value === undefined) {
                    throw new Error(message || 'Value should not be null or undefined');
                }
            }
            
            assertContains(container, item, message) {
                if (!container.includes(item)) {
                    throw new Error(message || `Container should contain ${item}`);
                }
            }
        }
        
        const testFramework = new TestFramework();
        
        // Mock fetch for testing
        const originalFetch = window.fetch;
        function mockFetch(url, options) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (url.includes('/chat')) {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({
                                message: 'Mock AI response',
                                timestamp: new Date().toISOString(),
                                model: 'llama3:8b'
                            })
                        });
                    } else if (url.includes('/api/insights')) {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({
                                insights: [
                                    {
                                        category: 'test',
                                        content: 'Test insight',
                                        confidence: 0.8,
                                        timestamp: new Date().toISOString()
                                    }
                                ],
                                statistics: {
                                    total_insights: 1,
                                    total_conversations: 1,
                                    categories: { test: 1 }
                                }
                            })
                        });
                    } else if (url.includes('/api/serendipity')) {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({
                                connections: [
                                    {
                                        title: 'Test Connection',
                                        description: 'Test connection description',
                                        surprise_factor: 0.7,
                                        relevance: 0.8
                                    }
                                ],
                                serendipity_summary: 'Test summary'
                            })
                        });
                    } else {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({ success: true })
                        });
                    }
                }, 100);
            });
        }
        
        // Chat functionality tests
        testFramework.addTest('Chat - DOM Elements Exist', () => {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatLog = document.getElementById('chat-log');
            
            testFramework.assertNotNull(messageInput, 'Message input should exist');
            testFramework.assertNotNull(sendButton, 'Send button should exist');
            testFramework.assertNotNull(chatLog, 'Chat log should exist');
        });
        
        testFramework.addTest('Chat - Message Display', () => {
            const chatLog = document.getElementById('chat-log');
            chatLog.innerHTML = '';
            
            // Simulate displayMessage function
            function displayMessage(message, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
                messageElement.textContent = message;
                chatLog.appendChild(messageElement);
            }
            
            displayMessage('Hello', 'user');
            displayMessage('Hi there!', 'assistant');
            
            const messages = chatLog.querySelectorAll('.message');
            testFramework.assertEqual(messages.length, 2, 'Should have 2 messages');
            testFramework.assert(messages[0].classList.contains('user-message'), 'First message should be user message');
            testFramework.assert(messages[1].classList.contains('ai-message'), 'Second message should be AI message');
        });
        
        testFramework.addTest('Chat - Input Validation', () => {
            const messageInput = document.getElementById('message-input');
            
            // Test empty message validation
            messageInput.value = '';
            const isEmpty = messageInput.value.trim() === '';
            testFramework.assert(isEmpty, 'Empty message should be detected');
            
            // Test non-empty message
            messageInput.value = 'Hello world';
            const isNotEmpty = messageInput.value.trim() !== '';
            testFramework.assert(isNotEmpty, 'Non-empty message should be valid');
        });
        
        testFramework.addTest('Chat - Conversation History Management', async () => {
            // Test conversation history array
            let conversationHistory = [];
            
            // Add messages
            conversationHistory.push({ role: 'user', content: 'Hello' });
            conversationHistory.push({ role: 'assistant', content: 'Hi there!' });
            
            testFramework.assertEqual(conversationHistory.length, 2, 'Should have 2 messages in history');
            testFramework.assertEqual(conversationHistory[0].role, 'user', 'First message should be from user');
            testFramework.assertEqual(conversationHistory[1].role, 'assistant', 'Second message should be from assistant');
        });
        
        // Dashboard functionality tests
        testFramework.addTest('Dashboard - DOM Elements Exist', () => {
            const elements = [
                'loading-state', 'error-state', 'empty-state', 'dashboard-content',
                'insights-container', 'categories-container', 'summaries-container'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                testFramework.assertNotNull(element, `Element ${id} should exist`);
            });
        });
        
        testFramework.addTest('Dashboard - State Management', () => {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const emptyState = document.getElementById('empty-state');
            const dashboardContent = document.getElementById('dashboard-content');
            
            // Test showing loading state
            loadingState.style.display = 'flex';
            errorState.style.display = 'none';
            emptyState.style.display = 'none';
            dashboardContent.style.display = 'none';
            
            testFramework.assertEqual(loadingState.style.display, 'flex', 'Loading state should be visible');
            testFramework.assertEqual(errorState.style.display, 'none', 'Error state should be hidden');
        });
        
        testFramework.addTest('Dashboard - Data Rendering', () => {
            const insightsContainer = document.getElementById('insights-container');
            
            // Mock insight data
            const mockInsights = [
                {
                    category: 'interests',
                    content: 'User likes AI',
                    confidence: 0.9,
                    timestamp: new Date().toISOString()
                }
            ];
            
            // Simulate rendering insights
            insightsContainer.innerHTML = mockInsights.map(insight => `
                <div class="insight-card">
                    <div class="insight-category">${insight.category}</div>
                    <div class="insight-content">${insight.content}</div>
                    <div class="insight-confidence">${Math.round(insight.confidence * 100)}%</div>
                </div>
            `).join('');
            
            const insightCards = insightsContainer.querySelectorAll('.insight-card');
            testFramework.assertEqual(insightCards.length, 1, 'Should render 1 insight card');
            
            const category = insightCards[0].querySelector('.insight-category');
            testFramework.assertEqual(category.textContent, 'interests', 'Category should be rendered correctly');
        });
        
        testFramework.addTest('Dashboard - Filter Functionality', () => {
            const categoryFilter = document.getElementById('category-filter');
            const confidenceFilter = document.getElementById('confidence-filter');
            
            // Test filter options
            categoryFilter.innerHTML = `
                <option value="">All Categories</option>
                <option value="interests">Interests</option>
                <option value="skills">Skills</option>
            `;
            
            confidenceFilter.innerHTML = `
                <option value="">All Confidence</option>
                <option value="high">High (80%+)</option>
                <option value="medium">Medium (50-80%)</option>
                <option value="low">Low (<50%)</option>
            `;
            
            testFramework.assertEqual(categoryFilter.options.length, 3, 'Category filter should have 3 options');
            testFramework.assertEqual(confidenceFilter.options.length, 4, 'Confidence filter should have 4 options');
        });
        
        testFramework.addTest('Dashboard - Pagination', () => {
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');
            
            // Test pagination state
            let currentPage = 1;
            let totalPages = 3;
            
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            testFramework.assert(prevButton.disabled, 'Previous button should be disabled on first page');
            testFramework.assert(!nextButton.disabled, 'Next button should be enabled when not on last page');
            testFramework.assertContains(pageInfo.textContent, 'Page 1 of 3', 'Page info should show current page');
        });
        
        // Prompt management tests
        testFramework.addTest('Prompts - DOM Elements Exist', () => {
            const elements = [
                'current-prompt-display', 'prompt-stats', 'prompt-editor',
                'prompt-name', 'validation-result', 'test-result', 'prompt-history-list'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                testFramework.assertNotNull(element, `Element ${id} should exist`);
            });
        });
        
        testFramework.addTest('Prompts - Validation Logic', () => {
            const promptEditor = document.getElementById('prompt-editor');
            const validationResult = document.getElementById('validation-result');
            
            // Test empty prompt validation
            promptEditor.value = '';
            const isEmpty = promptEditor.value.trim() === '';
            testFramework.assert(isEmpty, 'Empty prompt should be detected');
            
            // Test valid prompt
            promptEditor.value = 'You are a helpful AI assistant.';
            const isValid = promptEditor.value.trim().length > 10;
            testFramework.assert(isValid, 'Valid prompt should pass basic validation');
        });
        
        testFramework.addTest('Prompts - History Management', () => {
            const historyList = document.getElementById('prompt-history-list');
            
            // Mock prompt history
            const mockHistory = [
                {
                    name: 'Default Prompt',
                    prompt: 'You are a helpful assistant.',
                    created_at: new Date().toISOString(),
                    is_default: true
                },
                {
                    name: 'Custom Prompt',
                    prompt: 'You are a creative writer.',
                    created_at: new Date().toISOString(),
                    is_default: false
                }
            ];
            
            // Simulate rendering history
            historyList.innerHTML = mockHistory.map((prompt, index) => `
                <div class="prompt-history-item">
                    <div class="prompt-name">${prompt.name}</div>
                    <div class="prompt-preview">${prompt.prompt.substring(0, 50)}...</div>
                </div>
            `).join('');
            
            const historyItems = historyList.querySelectorAll('.prompt-history-item');
            testFramework.assertEqual(historyItems.length, 2, 'Should render 2 history items');
        });
        
        // Utility function tests
        testFramework.addTest('Utilities - Date Formatting', () => {
            // Test date formatting function
            function formatDate(date) {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            const testDate = new Date('2024-01-01T12:00:00Z');
            const formatted = formatDate(testDate);
            
            testFramework.assertContains(formatted, '2024', 'Formatted date should contain year');
            testFramework.assertContains(formatted, 'Jan', 'Formatted date should contain month');
        });
        
        testFramework.addTest('Utilities - HTML Escaping', () => {
            // Test HTML escaping function
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            const dangerousText = '<script>alert(\"xss\")</script>';
            const escaped = escapeHtml(dangerousText);
            
            testFramework.assert(!escaped.includes('<script>'), 'Script tags should be escaped');
            testFramework.assertContains(escaped, '&lt;script&gt;', 'Should contain escaped HTML');
        });
        
        // API Integration tests
        testFramework.addTest('API - Mock Fetch Chat', async () => {
            window.fetch = mockFetch;
            
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversation: [{ role: 'user', content: 'Hello' }] })
            });
            
            testFramework.assert(response.ok, 'Chat API should respond successfully');
            
            const data = await response.json();
            testFramework.assertNotNull(data.message, 'Response should contain message');
            testFramework.assertEqual(data.model, 'llama3:8b', 'Response should contain model info');
            
            window.fetch = originalFetch;
        });
        
        testFramework.addTest('API - Mock Fetch Insights', async () => {
            window.fetch = mockFetch;
            
            const response = await fetch('/api/insights');
            testFramework.assert(response.ok, 'Insights API should respond successfully');
            
            const data = await response.json();
            testFramework.assertNotNull(data.insights, 'Response should contain insights');
            testFramework.assertNotNull(data.statistics, 'Response should contain statistics');
            
            window.fetch = originalFetch;
        });
        
        // Test runner functions
        function runAllTests() {
            testFramework.runTests();
        }
        
        function runChatTests() {
            testFramework.runTests('Chat');
        }
        
        function runDashboardTests() {
            testFramework.runTests('Dashboard');
        }
        
        function runPromptTests() {
            testFramework.runTests('Prompts');
        }
        
        function clearResults() {
            document.getElementById('test-output').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
        }
        
        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Frontend test framework loaded. Use runAllTests() to start testing.');
        });
    </script>
</body>
</html>