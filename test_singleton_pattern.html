<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Singleton Pattern Test - Synapse AI</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <div class="hud-container">
        <div class="cognitive-dashboard">
            <header class="dashboard-header">
                <h2 class="dashboard-title">DASHBOARD SINGLETON PATTERN TEST</h2>
                <div class="dashboard-controls">
                    <button class="hud-button primary" id="test-singleton">
                        <span class="button-icon">üî¨</span>
                        Test Singleton Pattern
                    </button>
                    <button class="hud-button secondary" id="test-multiple-instances">
                        <span class="button-icon">üìä</span>
                        Test Multiple Instances
                    </button>
                    <button class="hud-button danger" id="reset-singleton">
                        <span class="button-icon">üîÑ</span>
                        Reset Singleton
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Test Results -->
                <section class="insights-section">
                    <h3 class="section-title">Test Results</h3>
                    <div id="test-results" class="hud-card">
                        <p>Click a test button to begin testing the singleton pattern...</p>
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="charts-section">
                    <h3 class="section-title">Chart Manager Status</h3>
                    <div id="singleton-status" class="hud-card">
                        <p><strong>Chart Manager Instance:</strong> <span id="instance-status">Not initialized</span></p>
                        <p><strong>Reference Count:</strong> <span id="ref-count">0</span></p>
                        <p><strong>Instance ID:</strong> <span id="instance-id">None</span></p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Load JavaScript files -->
    <script src="static/js/cognitive-charts.js"></script>
    <script src="static/js/dashboard.js"></script>

    <script>
        class SingletonPatternTest {
            constructor() {
                this.dashboardInstances = [];
                this.testCounter = 0;
                this.bindEvents();
                this.updateStatus();
            }

            bindEvents() {
                document.getElementById('test-singleton').addEventListener('click', () => {
                    this.testSingletonBehavior();
                });

                document.getElementById('test-multiple-instances').addEventListener('click', () => {
                    this.testMultipleInstances();
                });

                document.getElementById('reset-singleton').addEventListener('click', () => {
                    this.resetSingleton();
                });
            }

            logResult(message, type = 'info') {
                const resultsDiv = document.getElementById('test-results');
                const timestamp = new Date().toLocaleTimeString();
                const resultClass = type === 'error' ? 'test-fail' : type === 'success' ? 'test-pass' : 'test-info';
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${resultClass}">
                        <strong>[${timestamp}]</strong> ${message}
                    </div>
                `;
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
                
                // Update status display
                this.updateStatus();
            }

            updateStatus() {
                document.getElementById('instance-status').textContent = 
                    Dashboard.chartManagerInstance ? 'Initialized' : 'Not initialized';
                
                document.getElementById('ref-count').textContent = 
                    Dashboard.chartManagerRefCount || 0;
                
                if (Dashboard.chartManagerInstance) {
                    // Create a unique identifier for the instance
                    if (!Dashboard.chartManagerInstance._testId) {
                        Dashboard.chartManagerInstance._testId = `instance-${++this.testCounter}`;
                    }
                    document.getElementById('instance-id').textContent = 
                        Dashboard.chartManagerInstance._testId;
                } else {
                    document.getElementById('instance-id').textContent = 'None';
                }
            }

            testSingletonBehavior() {
                this.logResult('=== Testing Singleton Behavior ===');
                
                try {
                    // Create first dashboard instance
                    this.logResult('Creating first Dashboard instance...');
                    const dashboard1 = new Dashboard();
                    const chartManager1 = dashboard1.chartManager;
                    const instanceId1 = chartManager1 ? chartManager1._testId : 'None';
                    
                    this.logResult(`First instance chart manager ID: ${instanceId1}`);
                    
                    // Create second dashboard instance
                    this.logResult('Creating second Dashboard instance...');
                    const dashboard2 = new Dashboard();
                    const chartManager2 = dashboard2.chartManager;
                    const instanceId2 = chartManager2 ? chartManager2._testId : 'None';
                    
                    this.logResult(`Second instance chart manager ID: ${instanceId2}`);
                    
                    // Check if they reference the same instance
                    if (chartManager1 === chartManager2) {
                        this.logResult('‚úÖ SUCCESS: Both dashboards reference the same chart manager instance', 'success');
                    } else {
                        this.logResult('‚ùå FAILURE: Different chart manager instances detected', 'error');
                    }
                    
                    // Check reference count
                    const refCount = Dashboard.chartManagerRefCount;
                    this.logResult(`Reference count: ${refCount}`);
                    
                    if (refCount === 2) {
                        this.logResult('‚úÖ SUCCESS: Reference count correctly tracks multiple references', 'success');
                    } else {
                        this.logResult(`‚ùå FAILURE: Expected reference count 2, got ${refCount}`, 'error');
                    }
                    
                    // Clean up test instances
                    dashboard1.cleanup();
                    dashboard2.cleanup();
                    
                    this.logResult(`After cleanup - Reference count: ${Dashboard.chartManagerRefCount}`);
                    this.logResult(`After cleanup - Instance exists: ${Dashboard.chartManagerInstance ? 'Yes' : 'No'}`);
                    
                } catch (error) {
                    this.logResult(`‚ùå TEST ERROR: ${error.message}`, 'error');
                    console.error('Singleton test error:', error);
                }
            }

            testMultipleInstances() {
                this.logResult('=== Testing Multiple Instances Management ===');
                
                try {
                    const instances = [];
                    const targetCount = 5;
                    
                    // Create multiple dashboard instances
                    for (let i = 1; i <= targetCount; i++) {
                        this.logResult(`Creating Dashboard instance ${i}...`);
                        const dashboard = new Dashboard();
                        instances.push(dashboard);
                        
                        // Verify all instances share the same chart manager
                        if (i > 1) {
                            const sameInstance = dashboard.chartManager === instances[0].chartManager;
                            if (!sameInstance) {
                                this.logResult(`‚ùå Instance ${i} has different chart manager!`, 'error');
                            }
                        }
                    }
                    
                    this.logResult(`Created ${targetCount} dashboard instances`);
                    this.logResult(`Reference count: ${Dashboard.chartManagerRefCount}`);
                    
                    if (Dashboard.chartManagerRefCount === targetCount) {
                        this.logResult('‚úÖ SUCCESS: Reference count matches instance count', 'success');
                    } else {
                        this.logResult(`‚ùå FAILURE: Expected ${targetCount} refs, got ${Dashboard.chartManagerRefCount}`, 'error');
                    }
                    
                    // Clean up instances one by one
                    for (let i = 0; i < instances.length; i++) {
                        instances[i].cleanup();
                        const remainingRefs = Dashboard.chartManagerRefCount;
                        const expectedRefs = targetCount - (i + 1);
                        
                        this.logResult(`After cleanup ${i + 1}: ${remainingRefs} refs remaining (expected: ${expectedRefs})`);
                        
                        if (remainingRefs !== expectedRefs) {
                            this.logResult(`‚ùå Reference count mismatch at cleanup ${i + 1}`, 'error');
                        }
                    }
                    
                    // Verify singleton is properly cleaned up
                    if (Dashboard.chartManagerInstance === null && Dashboard.chartManagerRefCount === 0) {
                        this.logResult('‚úÖ SUCCESS: Singleton properly cleaned up after all instances destroyed', 'success');
                    } else {
                        this.logResult('‚ùå FAILURE: Singleton not properly cleaned up', 'error');
                    }
                    
                } catch (error) {
                    this.logResult(`‚ùå TEST ERROR: ${error.message}`, 'error');
                    console.error('Multiple instances test error:', error);
                }
            }

            resetSingleton() {
                this.logResult('=== Resetting Singleton ===');
                Dashboard.resetChartManager();
                this.logResult('Singleton forcefully reset using static method', 'info');
                this.updateStatus();
            }
        }

        // Initialize test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Singleton Pattern Test initialized');
            new SingletonPatternTest();
        });
    </script>

    <style>
        .test-result {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        #test-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }

        .hud-button.danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .hud-button.danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        #singleton-status p {
            margin: 8px 0;
            font-family: monospace;
        }

        #singleton-status span {
            font-weight: bold;
            color: var(--hud-primary);
        }
    </style>
</body>
</html>
