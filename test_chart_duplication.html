<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Duplication Test - Synapse AI</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <div class="hud-container">
        <div class="cognitive-dashboard">
            <header class="dashboard-header">
                <h2 class="dashboard-title">CHART DUPLICATION TEST</h2>
                <div class="dashboard-controls">
                    <button class="hud-button primary" id="test-initialization">
                        <span class="button-icon">🔬</span>
                        Test Chart Initialization
                    </button>
                    <button class="hud-button secondary" id="count-containers">
                        <span class="button-icon">📊</span>
                        Count Chart Containers
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Test Results -->
                <section class="insights-section">
                    <h3 class="section-title">Test Results</h3>
                    <div id="test-results" class="hud-card">
                        <p>Click "Test Chart Initialization" to begin testing...</p>
                    </div>
                </section>

                <!-- Charts Section (This is where duplication would occur) -->
                <section class="charts-section">
                    <h3 class="section-title">Chart Containers</h3>
                    <!-- Chart containers will be created here by dashboard.js -->
                    <!-- If duplication occurs, cognitive-charts.js would also create containers here -->
                </section>
            </div>
        </div>
    </div>

    <!-- Load JavaScript files in the order they would normally load -->
    <script src="static/js/cognitive-charts.js"></script>
    <script src="static/js/dashboard.js"></script>

    <script>
        class ChartDuplicationTest {
            constructor() {
                this.dashboard = null;
                this.chartManager = null;
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('test-initialization').addEventListener('click', () => {
                    this.runInitializationTest();
                });

                document.getElementById('count-containers').addEventListener('click', () => {
                    this.countChartContainers();
                });
            }

            logResult(message, type = 'info') {
                const resultsDiv = document.getElementById('test-results');
                const timestamp = new Date().toLocaleTimeString();
                const resultClass = type === 'error' ? 'test-fail' : type === 'success' ? 'test-pass' : 'test-info';
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${resultClass}">
                        <strong>[${timestamp}]</strong> ${message}
                    </div>
                `;
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }

            runInitializationTest() {
                this.logResult('Starting chart duplication test...');
                
                try {
                    // Step 1: Initialize Dashboard (should create chart containers)
                    this.logResult('Step 1: Initializing Dashboard...');
                    this.dashboard = new Dashboard();
                    
                    // Count containers after dashboard initialization
                    let containerCount = this.countChartContainers(false);
                    this.logResult(`After Dashboard init: Found ${containerCount} chart containers`, 
                                 containerCount === 3 ? 'success' : 'error');

                    // Step 2: Initialize Chart Manager (should NOT create additional containers)
                    this.logResult('Step 2: Initializing CognitiveChartManager...');
                    this.chartManager = new CognitiveChartManager();
                    this.chartManager.init();
                    
                    // Count containers after chart manager initialization
                    containerCount = this.countChartContainers(false);
                    this.logResult(`After ChartManager init: Found ${containerCount} chart containers`, 
                                 containerCount === 3 ? 'success' : 'error');

                    // Step 3: Check for specific container IDs
                    this.checkContainerUniqueness();

                    // Final assessment
                    if (containerCount === 3) {
                        this.logResult('✅ TEST PASSED: No container duplication detected!', 'success');
                    } else {
                        this.logResult(`❌ TEST FAILED: Expected 3 containers, found ${containerCount}`, 'error');
                    }

                } catch (error) {
                    this.logResult(`❌ TEST ERROR: ${error.message}`, 'error');
                    console.error('Test error:', error);
                }
            }

            countChartContainers(log = true) {
                const containers = document.querySelectorAll('.chart-container');
                const chartsGrid = document.querySelectorAll('.charts-grid');
                const coreValuesContainers = document.querySelectorAll('#core-values-container');
                const recurringThemesContainers = document.querySelectorAll('#recurring-themes-container');
                const emotionalLandscapeContainers = document.querySelectorAll('#emotional-landscape-container');

                if (log) {
                    this.logResult('=== CONTAINER COUNT SUMMARY ===');
                    this.logResult(`Total chart containers: ${containers.length}`);
                    this.logResult(`Charts grids: ${chartsGrid.length}`);
                    this.logResult(`Core Values containers: ${coreValuesContainers.length}`);
                    this.logResult(`Recurring Themes containers: ${recurringThemesContainers.length}`);
                    this.logResult(`Emotional Landscape containers: ${emotionalLandscapeContainers.length}`);
                    
                    if (containers.length > 3) {
                        this.logResult(`⚠️  WARNING: Found ${containers.length} chart containers (expected 3)`, 'error');
                    } else if (containers.length === 3) {
                        this.logResult('✅ Correct number of chart containers found', 'success');
                    }
                }

                return containers.length;
            }

            checkContainerUniqueness() {
                const containerIds = ['core-values-container', 'recurring-themes-container', 'emotional-landscape-container'];
                
                this.logResult('Checking container uniqueness...');
                
                containerIds.forEach(id => {
                    const elements = document.querySelectorAll(`#${id}`);
                    if (elements.length > 1) {
                        this.logResult(`❌ DUPLICATE: Found ${elements.length} elements with ID "${id}"`, 'error');
                    } else if (elements.length === 1) {
                        this.logResult(`✅ UNIQUE: Single element with ID "${id}"`, 'success');
                    } else {
                        this.logResult(`⚠️  MISSING: No element with ID "${id}"`, 'error');
                    }
                });
            }
        }

        // Initialize test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Chart Duplication Test initialized');
            new ChartDuplicationTest();
        });
    </script>

    <style>
        .test-result {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        #test-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }
    </style>
</body>
</html>
